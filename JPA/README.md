# JPA

## 목차

- [JPA란](#jpa란)
- [JPQL](#jpql)
- [엔티티](#엔티티)
- [영속성 컨텍스트](#영속성-컨텍스트)
## 정리할 것들
- MyBatis vs JPA
---

## JPA란
- Java Persistence API
- 자바 진영의 ORM 기술 표준으로, SQL 중심의 개발에서 객체 중심의 개발을 할 수 있도록 기능을 제공한다.
- JPA는 인터페이스 모음이다.
  - 구현체 : 하이버네이트, Eclipse, DataNucleus
  - 하이버네이트가 많이 사용된다.
- 애플리케이션과 JDBC 사이에서 동작한다.
- 특정 데이터베이스에 종속되지 않는다.
![image](https://user-images.githubusercontent.com/87891581/168938724-db0f7919-323f-4f60-ab7c-bd069c534ff7.png)

### ORM
- Object Relational Mapping
- 객체는 객체대로 설계하고, 관계형 데이터베이스는 관계형 데이터베이스대로 설계하더라도, ORM 프레임워크가 자바 객체와 관계형 DB를 매핑해준다.

### 장점
- SQL 중심적인 개발에서 객체 중심으로 개발
- 생산성
  - 반복적인 CRUD 작업을 하지 않아도 된다.
- 유지보수
  - 필드를 수정하면 SQL은 JPA가 처리해준다.
- 패러다임의 불일치 해결
  - 객체는 추상화, 상속, 다형성이라는 개념이 있고, 연관관계를 참조로 맺는다.
  - 관게형 데이터베이스에는 추상화, 상속, 다형성이라는 개념이 없고, 연관관계를 외래키로 맺는다.
  - 이런 패러다임의 불일치 사이에서 데이터를 주고 받으려면 번거로운 변환 작업이 필요하다. 이를 JPA가 해결해준다.
- 성능
  - JPA는 캐시와 버퍼 기능을 지원하기 때문에 잘 활용하면 성능 향상이 가능하다.

## JPQL
- JPA를 사용하면 엔티티 객체를 중심을 개발할 수 있다. 하지만 필요한 데이터만 DB에서 불러오기 위해 SQL이 필요한 순간이 있다.
- 이를 위해 JPA는 테이블이 아닌 객체를 대상으로 하는 객체 지향 쿼리 언어를 제공하며, 이를 JPQL이라고 부른다.

## 엔티티
- 데이터베이스 테이블과 ORM 매핑되어 있는 객체이다.
- `@Entity`가 붙은 클래스는 JPA가 관리하며, 엔티티라고 부른다.

### 엔티티의 생명 주기
![image](https://user-images.githubusercontent.com/87891581/168966197-c708e0b4-ca49-4e0c-898b-7d30a478330a.png)
- 비영속(new/transient) : 영속성 컨텍스트와 전혀 관계가 없는 순수한 객체 상태
- 영속(managed) : 영속성 컨텍스트에 의해 관리되는 상태
- 준영속(detached) : 영속 상태의 엔티티가 영속성 컨텍스트에서 분리된 상태
    - 영속 상태가 된적이 있기 때문에 반드시 식별자가 있다.
- 삭제(removed) : 삭제된 상태

## 영속성 컨텍스트
- 엔티티를 영구 저장하는 환경이라는 뜻이다.
- 엔티티 매니저로 엔티티를 저장하거나 조회하면, 엔티티 매니저는 영속성 컨텍스트에 엔티티를 보관하고 관리한다.

### 이점
#### 1. 1차 캐시
- `save()`나 `find()`를 호출하면 엔티티가 1차 캐시에 등록된다. 
- 1차 캐시에 등록된 엔티티를 조회한다면, 조회 쿼리 없이 1차 캐시에서 바로 조회할 수 있다.
#### 2. 동일성(identity) 보장
- 영속 엔티티는 1차 캐시에서 조회하므로 동일한 참조값의 엔티티를 보장한다.
#### 3. 트랜잭션을 지원하는 쓰기 지연(transactional write-behind)
- 엔티티 매니저로 CRUD 작업을 하면, 곧바로 쿼리를 보내지 않고 sql문을 모아두었다가 커밋하면 한번에 전송한다.
#### 4. 변경 감지(dirty checking)
- 영속 엔티티의 데이터를 수정하고 플러시하면, 자동으로 데이터베이스에 반영된다.
- 과정
  1. 영속 엔티티의 데이터 수정 후 플러시 발생
  2. 영속성 컨텍스트가 스냅샷과 엔티티를 비교하여 변경을 감지
  3. 쓰기 지연 SQL 저장소에 UPDATE 쿼리 등록
  4. 쓰기 지연 SQL 저장소의 쿼리를 데이터베이스에 전송
#### 5. 지연 로딩(lazy loading)

### 플러시
- 영속성 컨텍스트의 변경 내용을 데이터베이스에 반영
  - 영속성 컨텍스트를 비우지 않는다.
- 플러시하는 방법
  - `em.flush()` - 직접 호출
  - 트랜잭션 커밋 - 플러시 자동 호출
  - JPQL 쿼리 실행 - 플러시 자동 호출
